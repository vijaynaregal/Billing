<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        let invoiceData = [];
        let discountPercent = 0;
        let discountEnabled = false;
        let invoiceDate = "";
        let invoiceNumber = "";
        let paymentMethod = "";

        // Optional Base64 logo. If invalid or empty, it's safely skipped.
        const base64Logo = ""; // Put your valid Base64 data URL here if needed.

        function generateInvoiceNumber() {
            return "INV-" + Math.floor(100000 + Math.random() * 900000);
        }

        function setPaymentMethod(method) {
            paymentMethod = method;
            document.getElementById("cashButton").classList.toggle("bg-green-700", method === "Cash");
            document.getElementById("onlineButton").classList.toggle("bg-blue-700", method === "Online");
        }

        function addProduct() {
            const name = document.getElementById("productNameInput").value.trim();
            const price = parseFloat(document.getElementById("productPriceInput").value);
            const quantity = parseInt(document.getElementById("productQuantityInput").value);
            if (!name || isNaN(price) || isNaN(quantity) || price < 0 || quantity <= 0) {
                alert("Enter valid product details.");
                return;
            }
            invoiceData.push({ name, price, quantity });
            localStorage.setItem("invoiceProducts", JSON.stringify(invoiceData));
            loadInvoice();
            document.getElementById("productNameInput").value = "";
            document.getElementById("productPriceInput").value = "";
            document.getElementById("productQuantityInput").value = "";
        }

        function removeProduct(index) {
            invoiceData.splice(index, 1);
            localStorage.setItem("invoiceProducts", JSON.stringify(invoiceData));
            loadInvoice();
        }

        function editProductPrice(index) {
            const newPrice = prompt("Enter new price for this product:", invoiceData[index].price);
            if (newPrice !== null) {
                const price = parseFloat(newPrice);
                if (!isNaN(price) && price >= 0) {
                    invoiceData[index].price = price;
                    localStorage.setItem("invoiceProducts", JSON.stringify(invoiceData));
                    loadInvoice();
                } else {
                    alert("Invalid price entered.");
                }
            }
        }

        // Discount UI helpers
        function syncDiscountUI() {
            const btn = document.getElementById("discountToggleButton");
            const input = document.getElementById("discountPercentInput");
            if (!btn || !input) return;

            btn.classList.toggle("bg-purple-700", discountEnabled);
            btn.classList.toggle("bg-gray-400", !discountEnabled);
            btn.textContent = discountEnabled ? "Discount: ON" : "Discount: OFF";

            input.disabled = !discountEnabled;
            input.classList.toggle("opacity-50", !discountEnabled);
            input.value = isFinite(discountPercent) ? discountPercent : 0;
        }

        function toggleDiscount() {
            discountEnabled = !discountEnabled;
            localStorage.setItem("invoiceDiscountEnabled", JSON.stringify(discountEnabled));
            syncDiscountUI();
            loadInvoice();
        }

        function updateDiscountPercent() {
            const input = document.getElementById("discountPercentInput");
            let val = parseFloat(input.value);
            if (isNaN(val)) val = 0;
            val = Math.max(0, Math.min(100, val));
            discountPercent = val;
            localStorage.setItem("invoiceDiscount", String(discountPercent));
            loadInvoice();
        }

        // GST calculation (INCLUSIVE): 5% if unit price < 2500, else 18%.
        // Prices entered are GST-inclusive; discount reduces the gross (inclusive) amount.
        // GST portion is derived as: inclusive_line * rate / (100 + rate)
        function calculateGSTBreakdown(items, discountPct) {
            const discountFactor = 1 - (discountPct > 0 ? (discountPct / 100) : 0);
            let gst5 = 0;
            let gst18 = 0;
            let subtotal = 0; // inclusive of GST

            items.forEach(p => {
                const lineTotal = p.price * p.quantity;            // inclusive
                const discountedLine = lineTotal * discountFactor; // inclusive after discount
                subtotal += discountedLine;

                if (p.price < 2500) {
                    gst5 += discountedLine * (5 / 105);
                } else {
                    gst18 += discountedLine * (18 / 118);
                }
            });

            const gstTotal = gst5 + gst18;
            const grandTotal = subtotal; // GST is inclusive
            return { gst5, gst18, subtotal, gstTotal, grandTotal };
        }

        function loadInvoice() {
            invoiceData = JSON.parse(localStorage.getItem("invoiceProducts")) || [];
            discountEnabled = JSON.parse(localStorage.getItem("invoiceDiscountEnabled") || "false");
            discountPercent = parseFloat(localStorage.getItem("invoiceDiscount"));
            if (!isFinite(discountPercent)) discountPercent = 0;
            syncDiscountUI();

            const now = new Date();
            invoiceDate = now.toLocaleString();
            invoiceNumber = generateInvoiceNumber();
            document.getElementById("invoiceDate").textContent = `Date: ${invoiceDate}`;
            document.getElementById("invoiceNumber").textContent = `Invoice No: ${invoiceNumber}`;

            let invoiceTable = document.getElementById("invoiceTable");
            invoiceTable.innerHTML = "";

            let totalBeforeDiscount = 0;
            invoiceData.forEach((product, idx) => {
                let row = document.createElement("tr");
                row.innerHTML = `
                    <td class="p-2 border">${product.name}</td>
                    <td class="p-2 border cursor-pointer" onclick="editProductPrice(${idx})">₹${product.price.toFixed(2)} <span class="text-blue-500 underline ml-2">Edit</span></td>
                    <td class="p-2 border">${product.quantity}</td>
                    <td class="p-2 border">₹${(product.price * product.quantity).toFixed(2)}</td>
                    <td class="p-2 border"><button onclick="removeProduct(${idx})" class="text-red-500 font-bold">Remove</button></td>
                `;
                totalBeforeDiscount += product.price * product.quantity;
                invoiceTable.appendChild(row);
            });

            const effectiveDiscount = discountEnabled ? discountPercent : 0;
            const discountAmount = (totalBeforeDiscount * effectiveDiscount) / 100;

            const { gst5, gst18, subtotal, gstTotal, grandTotal } =
                calculateGSTBreakdown(invoiceData, effectiveDiscount);

            document.getElementById("totalBeforeDiscount").textContent =
                `Total Before Discount: ₹${totalBeforeDiscount.toFixed(2)}`;
            document.getElementById("discountInfo").textContent = discountEnabled
                ? `Discount Applied: ${effectiveDiscount}% (₹${discountAmount.toFixed(2)})`
                : `Discount: OFF`;
            document.getElementById("gstAmount").textContent =
                `GST (Inclusive): ₹${gstTotal.toFixed(2)} (5%: ₹${gst5.toFixed(2)}, 18%: ₹${gst18.toFixed(2)})`;
            document.getElementById("finalAmount").textContent =
                `Total (GST Inclusive): ₹${grandTotal.toFixed(2)}`;
        }

        function safeAddLogo(doc) {
            if (!base64Logo) return;
            try {
                doc.addImage(base64Logo, "PNG", 80, 10, 50, 20);
            } catch (e) {
                console.warn("Logo add failed, skipping.", e);
            }
        }

        function ensureJsPDFAvailable() {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                throw new Error("jsPDF not available. Check your network or CDN blocking.");
            }
        }

        function manualItemsTable(doc, startY) {
            let y = startY;
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Items:", 15, y);
            y += 6;
            doc.setFont("helvetica", "normal");
            if (!invoiceData.length) {
                doc.text("No items.", 15, y);
                return y + 10;
            }
            // Simple listing: Name | Price | Qty | Total
            doc.setFont("helvetica", "bold");
            doc.text("Product", 15, y);
            doc.text("Price", 90, y);
            doc.text("Qty", 130, y);
            doc.text("Total", 160, y);
            y += 6;
            doc.setFont("helvetica", "normal");

            invoiceData.forEach(p => {
                doc.text(String(p.name), 15, y);
                doc.text(`₹${p.price.toFixed(2)}`, 90, y, { align: "left" });
                doc.text(String(p.quantity), 130, y);
                doc.text(`₹${(p.price * p.quantity).toFixed(2)}`, 160, y, { align: "left" });
                y += 6;
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            return y + 6;
        }

        function downloadPDF() {
            try {
                // Allow proceeding without a payment method (with confirmation)
                if (!paymentMethod) {
                    const proceed = confirm("No payment method selected. Do you want to continue?");
                    if (!proceed) return;
                }

                ensureJsPDFAvailable();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                safeAddLogo(doc);
                doc.setFontSize(20);
                doc.text("Invoice", 15, 40);
                doc.setFontSize(12);
                doc.text(`Invoice No: ${invoiceNumber}`, 15, 50);
                doc.text(`Date: ${invoiceDate}`, 15, 60);
                doc.text(`Payment Method: ${paymentMethod || "N/A"}`, 15, 70);

                let currentY = 80;

                // Table (try AutoTable, fallback to manual)
                const hasAutoTable = typeof doc.autoTable === "function";
                if (hasAutoTable) {
                    const tableData = invoiceData.map(p => [
                        p.name,
                        `₹${p.price.toFixed(2)}`,
                        p.quantity,
                        `₹${(p.price * p.quantity).toFixed(2)}`
                    ]);
                    doc.autoTable({
                        head: [["Product", "Price", "Quantity", "Total"]],
                        body: tableData,
                        startY: currentY
                    });
                    currentY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY + 10 : currentY + 10;
                } else {
                    currentY = manualItemsTable(doc, currentY);
                }

                // Totals and GST breakdown (INCLUSIVE)
                const totalAmount = invoiceData.reduce((sum, p) => sum + p.price * p.quantity, 0);
                const effectiveDiscount = discountEnabled ? discountPercent : 0;
                const discountAmount = (totalAmount * effectiveDiscount) / 100;

                const { gst5, gst18, subtotal, gstTotal, grandTotal } =
                    calculateGSTBreakdown(invoiceData, effectiveDiscount);

                doc.text(`Total Before Discount: ₹${totalAmount.toFixed(2)}`, 15, currentY);
                currentY += 10;

                doc.text(
                    discountEnabled
                        ? `Discount: ${effectiveDiscount}% (₹${discountAmount.toFixed(2)})`
                        : `Discount: OFF`,
                    15,
                    currentY
                );
                currentY += 10;

                doc.text(`Subtotal (after discount, GST inclusive): ₹${subtotal.toFixed(2)}`, 15, currentY);
                currentY += 10;

                doc.text(
                    `GST (Inclusive): ₹${gstTotal.toFixed(2)} (5%: ₹${gst5.toFixed(2)}, 18%: ₹${gst18.toFixed(2)})`,
                    15,
                    currentY
                );
                currentY += 10;

                doc.text(`Total (GST Inclusive): ₹${grandTotal.toFixed(2)}`, 15, currentY);

                // Try doc.save first
                try {
                    doc.save(`${invoiceNumber}.pdf`);
                } catch (e) {
                    console.warn("doc.save failed, using Blob fallback.", e);
                    const blob = doc.output("blob");
                    const url = URL.createObjectURL(blob);
                    // Anchor download fallback
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `${invoiceNumber}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        a.remove();
                        // In case the browser blocks programmatic click (e.g., iOS),
                        // attempt opening the Blob URL.
                        if (!document.hidden) {
                            window.open(url, "_blank");
                        }
                    }, 0);
                }
            } catch (err) {
                console.error("PDF generation error:", err);
                alert(
                    "Failed to generate the PDF.\n\nTips:\n" +
                    "- Make sure your network allows loading jsPDF and the AutoTable plugin.\n" +
                    "- Try disabling the logo or ensure it is a valid Base64 data URL.\n" +
                    "- Check the browser console for errors."
                );
            }
        }

        window.onload = loadInvoice;
    </script>
</head>
<body class="bg-gray-200 flex flex-col items-center p-6">
    <h1 class="text-2xl font-bold mb-2">Atha Decor Invoice</h1>
    <h2 id="invoiceNumber" class="text-lg mb-2 font-semibold"></h2>
    <h2 id="invoiceDate" class="text-lg mb-4 font-semibold"></h2>

    <!-- Product Add Section -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-4 w-full max-w-lg">
        <h3 class="font-semibold mb-2">Add Product</h3>
        <div class="flex flex-wrap gap-2">
            <input id="productNameInput" type="text" placeholder="Product Name" class="p-2 border rounded flex-1" />
            <input id="productPriceInput" type="number" step="0.01" placeholder="Price" class="p-2 border rounded w-28" />
            <input id="productQuantityInput" type="number" placeholder="Quantity" class="p-2 border rounded w-20" />
            <button onclick="addProduct()" class="bg-green-500 text-white px-4 py-2 rounded">Add</button>
        </div>
    </div>

    <!-- Payment Method -->
    <label class="mt-2">Payment Method:</label>
    <div class="mt-2">
        <button id="cashButton" onclick="setPaymentMethod('Cash')" class="bg-green-500 text-white px-4 py-2 rounded mr-2">Cash</button>
        <button id="onlineButton" onclick="setPaymentMethod('Online')" class="bg-blue-500 text-white px-4 py-2 rounded">Online</button>
    </div>

    <!-- Discount Controls -->
    <div class="bg-white p-4 rounded-lg shadow-md mt-4 w-full max-w-lg">
        <h3 class="font-semibold mb-2">Discount</h3>
        <div class="flex items-center gap-3">
            <button id="discountToggleButton" onclick="toggleDiscount()" class="px-3 py-2 rounded text-white bg-gray-400">Discount: OFF</button>
            <div class="flex items-center gap-2">
                <label for="discountPercentInput" class="font-medium">Percent (%)</label>
                <input id="discountPercentInput" type="number" step="0.01" min="0" max="100" value="0"
                    onchange="updateDiscountPercent()" oninput="updateDiscountPercent()"
                    class="p-2 border rounded w-28 opacity-50" disabled />
            </div>
        </div>
        <p class="text-sm text-gray-600 mt-2">Prices entered are GST-inclusive. Discount applies to the gross amount; GST shown is the portion included in totals.</p>
    </div>

    <table class="bg-white shadow-md rounded-lg w-full max-w-lg mt-4">
        <thead>
            <tr class="bg-blue-500 text-white">
                <th class="p-2 border">Product</th>
                <th class="p-2 border">Price</th>
                <th class="p-2 border">Quantity</th>
                <th class="p-2 border">Total</th>
                <th class="p-2 border">Action</th>
            </tr>
        </thead>
        <tbody id="invoiceTable" class="text-center"></tbody>
    </table>

    <h2 id="totalBeforeDiscount" class="mt-4 text-lg font-bold">Total Before Discount: ₹0</h2>
    <h2 id="discountInfo" class="mt-2 text-lg font-bold">Discount: OFF</h2>
    <h2 id="gstAmount" class="mt-2 text-lg font-bold">GST (Inclusive): ₹0</h2>
    <h2 id="finalAmount" class="mt-2 text-lg font-bold">Total (GST Inclusive): ₹0</h2>

    <button onclick="downloadPDF()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded font-bold">Download PDF</button>
</body>
</html>
